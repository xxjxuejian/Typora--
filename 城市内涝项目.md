

### tokenå­˜å–

åç«¯è¿”å›äº†tokenï¼Œåªæœ‰ä¸€ä¸ªtokenï¼Œæ€ä¹ˆåšä¿å­˜ï¼Œæ€ä¹ˆéªŒè¯å¤±æ•ˆï¼Œå¤±æ•ˆäº†æ€ä¹ˆåšã€‚

é‡‡ç”¨çš„æ˜¯å•ä¸ªtokenï¼Œå¦‚æœè¿‡æœŸäº†ï¼Œåç«¯ä»…ä»…æ˜¯è¿”å›ä¸€ä¸ªè¿‡æœŸé€šçŸ¥ä»¥åŠçŠ¶æ€ç 401ã€‚

**æ€è·¯ï¼š**

å‰ç«¯å®šä¹‰ä¸€ä¸ªtokençš„è¿‡æœŸæ—¶é—´ã€‚ç™»å½•æˆåŠŸï¼Œè·å–åˆ°tokenä»¥åï¼Œå†æŠŠtokenå’Œå½“å‰æ—¶é—´æˆ³`timestamp`ä¿å­˜ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```js
const TOKEN_INFO_KEY = "tokenInfo";
const TOKEN_VALID_TIME = 1000 * 60 * 60 * 2; // 2å°æ—¶

const tokenInfo: TokenInfo = {
    token,
    timestamp: Date.now(), // è®°å½•è·å–tokençš„æ—¶é—´æˆ³
  };
```

è¿™æ ·å°±æŠŠæ¯æ¬¡ç™»å½•æ—¶çš„æ—¶é—´æˆ³è®°å½•äº†ä¸‹æ¥ã€‚ä¹‹åï¼Œåœ¨æ¯æ¬¡çš„ç½‘ç»œè¯·æ±‚æ‹¦æˆªå™¨ä¸­ï¼Œè·å–`tokenInfo`ï¼Œå¯ä»¥æ‹¿åˆ°`token`ä»¥åŠ`timestamp`ã€‚åŒæ—¶è·å–`Date.now()`æ—¶é—´ï¼Œç»“åˆæœ‰æ•ˆæœŸæ—¶é—´`TOKEN_VALID_TIME`ï¼Œå¯ä»¥ç¡®è®¤æ˜¯å¦è¿‡æœŸã€‚

```js
// æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
export const isTokenExpired = (): boolean => {
  // è·å–ä¸åˆ°tokenï¼Œå°±è®¤ä¸ºæ˜¯è¿‡æœŸäº†
  const tokenInfo = getTokenInfo();
  if (!tokenInfo) return true;

  return Date.now() - tokenInfo.timestamp > TOKEN_VALID_TIME;
};
```

å®Œæˆçš„å­˜å–`token`ä»¥åŠæ£€æŸ¥æ˜¯å¦è¿‡æœŸçš„å·¥å…·ä»£ç å¦‚ä¸‹ï¼š

```ts
// è®¾ç½®token,è·å–tokenç­‰
const TOKEN_INFO_KEY = "tokenInfo";
const TOKEN_VALID_TIME = 1000 * 60 * 60 * 2; // 2å°æ—¶

// ä¿å­˜tokenInfo
export const setToken = (token: string) => {
  const tokenInfo: TokenInfo = {
    token,
    timestamp: Date.now(), // è®°å½•è·å–tokençš„æ—¶é—´æˆ³
  };
  localStorage.setItem(TOKEN_INFO_KEY, JSON.stringify(tokenInfo));
};

// è·å–å®Œæ•´ tokenInfo çš„æ–¹æ³•
export const getTokenInfo = (): TokenInfo | null => {
  const str = localStorage.getItem(TOKEN_INFO_KEY);
  if (!str) return null;
  try {
    const data = JSON.parse(str);
    return isValidTokenInfo(data) ? data : null;
  } catch (err) {
    console.error("è·å–tokenInfoå¤±è´¥:", err);
    return null;
  }
};

// è·å–token
export const getToken = (): string | null => {
  const tokenInfo = getTokenInfo();
  return tokenInfo?.token || null;
};

// æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
export const isTokenExpired = (): boolean => {
  // è·å–ä¸åˆ°tokenï¼Œå°±è®¤ä¸ºæ˜¯è¿‡æœŸäº†
  const tokenInfo = getTokenInfo();
  if (!tokenInfo) return true;

  return Date.now() - tokenInfo.timestamp > TOKEN_VALID_TIME;
};

// åˆ é™¤token
export const clearToken = () => {
  localStorage.removeItem(TOKEN_INFO_KEY);
};

interface TokenInfo {
  token: string;
  timestamp: number;
}

// ç±»å‹å®ˆå«ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
function isValidTokenInfo(obj: any): obj is TokenInfo {
  return obj && typeof obj.token === "string" && typeof obj.timestamp === "number";
}
```



### ç¯å¢ƒå˜é‡è®¾ç½®ï¼š

ç°åœ¨æ˜¯å¼€å‘ç¯å¢ƒï¼Œ`.env.development`

```shell
# å˜é‡å¿…é¡»ä»¥ VITE_ ä¸ºå‰ç¼€æ‰èƒ½æš´éœ²ç»™å¤–éƒ¨è¯»å–
# app åç§°
VITE_APP_TITLE = 'waterlogging syetem'

# åº”ç”¨ç«¯å£
VITE_APP_PORT = 3005

# ä»£ç†å‰ç¼€
VITE_APP_BASE_URL = '/dev-api'

# æ¥å£åœ°å€
VITE_APP_TARGET_API_URL = 'http://tmws.zksy.com/apiProxy'
```



### `Axios`ç½‘ç»œè¯·æ±‚çš„å°è£…ï¼š

#### åˆ›å»ºè¯·æ±‚å®ä¾‹ï¼š

```js
const instance = axios.create({
  baseURL: import.meta.env.VITE_APP_BASE_URL,
  timeout: 1000 * 10,
  headers: {
    "Content-Type": "application/json;charset=UTF-8",
  },
  paramsSerializer: (params) => qs.stringify(params),
});
```

#### å‚æ•°é…ç½®

- `baseURL`ï¼š

  - ç»™æ‰€æœ‰ç½‘ç»œè¯·æ±‚æ·»åŠ çš„å‰ç¼€ï¼Œæ¯”å¦‚`/api`ï¼Œé‚£ä¹ˆ`axios.get('/user') => axios.get('/api/user')`  ã€‚
  - å¯ä»¥æ ¹æ®è¿™ä¸ªå‰ç¼€è®¾ç½®åå‘ä»£ç†ã€‚å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥æ˜¯çœŸå®çš„åç«¯æ¥å£åœ°å€`https://api.example.com`

- `headers`ï¼š

  - è®¾ç½®è¯·æ±‚å¤´ï¼Œå‘Šè¯‰æœåŠ¡å™¨ï¼šæœ¬æ¬¡å‘é€çš„è¯·æ±‚çš„**æ•°æ®æ ¼å¼**æ˜¯ JSONï¼Œ**å­—ç¬¦ç¼–ç **æ˜¯ UTF-8ï¼Œé¿å…å‡ºç°ä¸­æ–‡ä¹±ç ç­‰é—®é¢˜ã€‚
  - `Content-Type` æ˜¯**è¯·æ±‚å¤´å­—æ®µ**ï¼Œè¡¨ç¤º**è¯·æ±‚ä½“ï¼ˆbodyï¼‰é‡Œçš„æ•°æ®æ ¼å¼**æ˜¯ä»€ä¹ˆã€‚
  - æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æºå¸¦çš„æ•°æ®ä»¥åï¼Œä¼šæ ¹æ® `Content-Type` åˆ¤æ–­æ€ä¹ˆè§£ææ•°æ®ã€‚
  - å¦‚æœæ²¡è®¾ç½®ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šé»˜è®¤ç”¨ `application/x-www-form-urlencoded`ï¼ˆè¡¨å•æ ¼å¼ï¼‰å»è§£æï¼Œå¯¼è‡´è¯»ä¸åˆ°æ­£ç¡®çš„æ•°æ®ã€‚

- `paramsSerializer`:

  - è‡ªå®šä¹‰**æŸ¥è¯¢å‚æ•°çš„åºåˆ—åŒ–æ–¹å¼**ã€‚

  - é»˜è®¤ `axios` ä¼šæŠŠ `GET` è¯·æ±‚çš„ `params` å¯¹è±¡åºåˆ—åŒ–æˆ URL å‚æ•°ï¼Œä½†å¦‚æœä½ çš„å‚æ•°é‡Œæœ‰åµŒå¥—å¯¹è±¡æˆ–æ•°ç»„ï¼Œç”¨é»˜è®¤çš„å¯èƒ½ä¸ç¬¦åˆåç«¯è¦æ±‚ã€‚

  - `qs.stringify(params)` ä½¿ç”¨ `qs` åº“æ¥åºåˆ—åŒ–ï¼Œèƒ½æ­£ç¡®å¤„ç†å¤æ‚çš„å¯¹è±¡å’Œæ•°ç»„ï¼Œæ¯”å¦‚æŠŠï¼š

    ```js
    { a: 1, b: [2, 3] }
    ```

    è½¬æˆ URLï¼š

    ```js
    a=1&b[0]=2&b[1]=3
    ```

    ä¸è¿‡è¿™é‡Œå¹¶æ²¡æœ‰å®šä¹‰ï¼Œå‚æ•°æœ‰åµŒå¥—å¯¹è±¡æˆ–è€…æ•°ç»„æ—¶çš„åºåˆ—åŒ–æ–¹å¼ï¼Œå¯é€‰çš„æ–¹å¼å¦‚ä¸‹ï¼š

    ```js
    qs.stringify({ a: [1, 2, 3] }, { arrayFormat: 'brackets' })
    // => 'a[]=1&a[]=2&a[]=3'
    
    qs.stringify({ a: [1, 2, 3] }, { arrayFormat: 'indices' })
    // => 'a[0]=1&a[1]=2&a[2]=3'
    
    qs.stringify({ a: [1, 2, 3] }, { arrayFormat: 'repeat' })
    // => 'a=1&a=2&a=3'ï¼ˆè·Ÿé»˜è®¤ä¸€æ ·ï¼‰
    
    qs.stringify({ a: [1, 2, 3] }, { arrayFormat: 'comma' })
    // => 'a=1,2,3'
    
    // ç­‰ç­‰......
    ```



##### å…³äº`Content-Type`ï¼š

| Header å­—æ®µ            | è°è®¾ç½®ï¼Ÿ             | ç”¨äºä»€ä¹ˆ                              |
| ---------------------- | -------------------- | ------------------------------------- |
| `Content-Type`ï¼ˆè¯·æ±‚ï¼‰ | å‰ç«¯å‘é€è¯·æ±‚æ—¶è®¾ç½®   | å‘Šè¯‰æœåŠ¡å™¨è¯·æ±‚ä½“æ˜¯ä»€ä¹ˆæ ¼å¼ï¼Œä¾‹å¦‚ JSON |
| `Content-Type`ï¼ˆå“åº”ï¼‰ | æœåŠ¡å™¨è¿”å›å“åº”æ—¶è®¾ç½® | å‘Šè¯‰å®¢æˆ·ç«¯å“åº”ä½“æ˜¯ä»€ä¹ˆæ ¼å¼ï¼Œä¾‹å¦‚ JSON |

å¦‚æœæƒ³æ§åˆ¶æ¥æ”¶çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥è®¾ç½® `Accept`ï¼š

```js
headers: {
  'Accept': 'application/json'
}
```

##### æ˜¯å¦æœ‰å¿…è¦è®¾ç½® `Content-Type`ï¼Ÿ

ä»¥ä¸‹æ¥è‡ªchatGPTï¼Œæœªæ‰‹åŠ¨éªŒè¯

| æƒ…å†µ                                                   | æ˜¯å¦éœ€è¦æ‰‹åŠ¨è®¾ç½® `Content-Type` | è¯´æ˜                                                         |
| ------------------------------------------------------ | ------------------------------- | ------------------------------------------------------------ |
| å‘é€ JSON æ•°æ®ï¼ˆ`axios.post('/api', { foo: 'bar' })`ï¼‰ | âŒ ä¸éœ€è¦                        | Axios ä¼šè‡ªåŠ¨è®¾ç½®ä¸º `application/json;charset=utf-8`          |
| å‘é€ `FormData` æ•°æ®ï¼ˆå¦‚ä¸Šä¼ æ–‡ä»¶ï¼‰                     | âŒ ä¸éœ€è¦                        | Axios ä¼šè‡ªåŠ¨è®¾ç½®ä¸º `multipart/form-data`ï¼Œå¹¶å¸¦ä¸Šæ­£ç¡®çš„ `boundary` |
| å‘é€ URL ç¼–ç æ•°æ®ï¼ˆä½¿ç”¨ `URLSearchParams`ï¼‰            | âŒ ä¸éœ€è¦                        | Axios ä¼šè‡ªåŠ¨è®¾ç½®ä¸º `application/x-www-form-urlencoded;charset=utf-8` |
| è‡ªå®šä¹‰åºåˆ—åŒ–æ ¼å¼æˆ–ç‰¹æ®Šè¦æ±‚çš„æœåŠ¡ç«¯æ¥å£                 | âœ… å»ºè®®æ‰‹åŠ¨è®¾ç½®                  | ä¾‹å¦‚ä½ ä½¿ç”¨äº†ç‰¹æ®Šçš„ `qs.stringify`ï¼Œæˆ–è€…æœåŠ¡ç«¯å¯¹å¤´ä¿¡æ¯è¦æ±‚ä¸¥æ ¼ |

##### ğŸ“Œ Axios çš„é»˜è®¤è¡Œä¸ºï¼ˆä½ ä¸ç”¨æ‰‹åŠ¨è®¾ç½®çš„æƒ…å†µï¼‰

Axios ä¼šæ ¹æ®ä½ ä¼ å…¥çš„æ•°æ®ç±»å‹è‡ªåŠ¨åˆ¤æ–­å¹¶è®¾ç½®åˆé€‚çš„ `Content-Type`ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

| æ•°æ®ç±»å‹                      | Axios è‡ªåŠ¨è®¾ç½®çš„ Content-Type                     |
| ----------------------------- | ------------------------------------------------- |
| JavaScript å¯¹è±¡ (`{}`)        | `application/json;charset=utf-8`                  |
| `FormData` å¯¹è±¡               | `multipart/form-data; boundary=...`ï¼ˆè‡ªåŠ¨ï¼‰       |
| `URLSearchParams` å¯¹è±¡        | `application/x-www-form-urlencoded;charset=utf-8` |
| å…¶ä»–ç±»å‹ï¼ˆBlob, ArrayBufferï¼‰ | æ ¹æ®æµè§ˆå™¨è¡Œä¸ºï¼ŒAxios å¯èƒ½ä¸è‡ªåŠ¨è®¾ç½®              |

âš ï¸ æ³¨æ„ï¼š**ä¸è¦ç»™ `FormData` æ‰‹åŠ¨è®¾ç½® `Content-Type`**

```js
// âŒ ä¸è¦è¿™æ ·
headers: {
  'Content-Type': 'multipart/form-data'
}
```

å› ä¸ºæµè§ˆå™¨åœ¨å‘é€ multipart/form-data æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå¸¦æœ‰ boundary çš„ Content-Typeï¼Œå¦‚æœä½ æ‰‹åŠ¨å†™æ­»ï¼Œä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥æˆ–æœåŠ¡å™¨è§£æå¤±è´¥ã€‚

##### æ€»ç»“ï¼š

ç»å¤§å¤šæ•°åœºæ™¯ä¸‹ä½ ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® `Content-Type`ï¼ŒAxios ä¼šå¸®ä½ è‡ªåŠ¨è®¾ç½®ã€‚

åªæœ‰åœ¨ä½ éœ€è¦ç²¾ç»†æ§åˆ¶è¯·æ±‚æ ¼å¼ã€å¯¹æ¥ç‰¹åˆ«ä¸¥æ ¼çš„åç«¯ï¼Œæˆ–è€…ä½¿ç”¨äº† Axios çš„ `transformRequest`ã€è‡ªå®šä¹‰ data åºåˆ—åŒ–é€»è¾‘æ—¶ï¼Œæ‰éœ€è¦æ‰‹åŠ¨è®¾ç½®ã€‚

å¯¹äº JSON è¯·æ±‚ï¼Œå¯ä»¥è®¾ç½®ä¹Ÿå¯ä»¥ä¸è®¾ç½®ï¼Œä¸å½±å“ä½¿ç”¨ï¼š



#### è¯·æ±‚æ‹¦æˆªå™¨ï¼š

è¯·æ±‚æ‹¦æˆªå™¨ï¼Œæ˜¯ç½‘ç»œè¯·æ±‚æ‹¦æˆªå™¨ï¼Œåœ¨å‘é€ç½‘ç»œè¯·æ±‚ä¹‹å‰è¿›è¡Œæ‹¦æˆªï¼Œé‚£ä¹ˆæˆ‘ä»¬é€šå¸¸åœ¨ç½‘ç»œè¯·æ±‚æ‹¦æˆªä¸­åšä»€ä¹ˆå‘¢ï¼Ÿ

åç«¯çš„æœ‰äº›æ¥å£ï¼Œæ˜¯éœ€è¦æºå¸¦`token`æ‰èƒ½è®¿é—®çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨è¿™é‡Œç»Ÿä¸€æ·»åŠ `token`

##### æ ‡å‡†ã€æ¨èçš„åšæ³•æ˜¯ï¼š

è¯·æ±‚æ‹¦æˆªå™¨åªè´Ÿè´£æ·»åŠ  tokenï¼Œä¸è´Ÿè´£åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼›token æ˜¯å¦æœ‰æ•ˆç”±å“åº”æ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç†ã€‚



```js
// è¯·æ±‚æ‹¦æˆªå™¨
instance.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    // è¯·æ±‚æ‹¦æˆªå™¨ä¸­ åˆ¤æ–­æ˜¯å¦å­˜åœ¨token,å¹¶æ·»åŠ åˆ°è¯·æ±‚å¤´ Authorization ä¸­
    // é€»è¾‘ä»£ç ,è·å–tokenï¼Œæ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    const token = getToken();
    const isExpire = isTokenExpired();

    if (token) {
      if (!isExpire) {
        config.headers.Authorization = `Bearer ${token}`;
      } else {
        console.log("tokenè¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢");
        clearToken();
        router.push("/login");
      }
    }

    // å‡å¦‚tokenè¢«æˆ‘æ‰‹åŠ¨åˆ é™¤äº†ï¼Œæˆ‘åˆ·æ–°é¡µé¢ï¼ŒæŒ‰ç…§é“ç†æ¥è¯´ï¼Œè¿™æ¬¡è¯·æ±‚æ‹¿ä¸åˆ°token,å°±ä¸åº”è¯¥æ”¾è¡Œçš„ï¼Œæ‰€ä»¥æœ‰ä¸€ç‚¹ç‘•ç–µçš„ã€‚
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);
```

é€»è¾‘ä¼˜åŒ–ï¼š

```js
instance.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    // è¯·æ±‚æ‹¦æˆªå™¨ä¸­ åˆ¤æ–­æ˜¯å¦å­˜åœ¨token,å¹¶æ·»åŠ åˆ°è¯·æ±‚å¤´ Authorization ä¸­
    // é€»è¾‘ä»£ç ,è·å–tokenï¼Œæ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    const token = getToken();
    const isExpire = isTokenExpired();

    // èƒ½è·å–åˆ°tokençš„æƒ…å†µ
    if (token) {
      if (!isExpire) {
        config.headers.Authorization = `Bearer ${token}`;
        return config;
      } else {
        console.log("tokenè¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢");
        clearToken();
        router.push("/login");
        // ä¸­æ–­è¯·æ±‚ï¼Œèµ° .catch é€»è¾‘
        return Promise.reject(new Error("tokenè¿‡æœŸ"));
      }
    }
    // è·å–ä¸åˆ°tokenæƒ…å†µ
    else {
      if (whiteList.some((url) => config.url?.startsWith(url))) {
        return config; // ç™½åå•æ”¾è¡Œ
      } else {
        console.log("æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢");
        router.push("/login");
        // ä¸­æ–­è¯·æ±‚ï¼Œèµ° .catch é€»è¾‘
        return Promise.reject(new Error("æœªç™»å½•"));
      }
    }
  },
  (error) => {
    return Promise.reject(error);
  }
);
```

ä¸¤ä¸ª `return Promise.reject()` çš„æ„ä¹‰ï¼š

**ä¸­æ–­å½“å‰è¯·æ±‚é“¾ï¼š**

axios æ‹¿åˆ° rejectï¼Œ**ä¸ä¼šçœŸæ­£å‘èµ·è¯·æ±‚**ã€‚

**é”™è¯¯å¯ä»¥è¢«åç»­ `.catch` æ•è·**ï¼š

```js
instance.get('/xxx')
  .then(res => {
    // æ­£å¸¸å¤„ç†
  })
  .catch(err => {
    // æ•è·åˆ°"æœªç™»å½•"æˆ–"tokenè¿‡æœŸ"çš„é”™è¯¯
    console.error(err.message);
  });

```

ä¸ rejectï¼Œ`catch` æ ¹æœ¬æ•è·ä¸åˆ°ï¼Œç¨‹åºæ— æ³•æ­£ç¡®å“åº”å¼‚å¸¸ï¼

**ç¬¦åˆ Promise è§„èŒƒ**ï¼š
 axios æœ¬èº«å°±æ˜¯åŸºäº Promise çš„ï¼Œreject æ‰æ˜¯æ­£ç¡®çš„å¼‚å¸¸æµã€‚



3. å“åº”æ‹¦æˆªå™¨ï¼š

   ```js
   // å“åº”æ‹¦æˆªå™¨
   instance.interceptors.response.use(
     /* 
     HTTPçŠ¶æ€ç ï¼Œ2xx  æˆ– 3xx èŒƒå›´å†…çš„çŠ¶æ€ç éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°ã€‚
     æœåŠ¡å™¨æˆåŠŸè¿”å›äº†å“åº”ï¼ˆHTTP çŠ¶æ€ç ä¸º 2xx æˆ– 3xxï¼‰å°±ä¼šè§¦å‘ï¼Œå³ä½¿ä¸šåŠ¡ä¸Šæ˜¯å¤±è´¥çš„(æŒ‡åç«¯)
     */
     (response: AxiosResponse) => {
       // å¦‚æœå“åº”æ˜¯äºŒè¿›åˆ¶æµï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œç”¨äºä¸‹è½½æ–‡ä»¶ã€Excel å¯¼å‡ºç­‰
       if (response.config.responseType === "blob") {
         return response;
       }
   
       const { code, msg } = response.data;
       // åç«¯è¿”å›çš„code çŠ¶æ€ç 
       if (code === 200) {
         return response.data;
       } else if (code === 401) {
         ElMessage.warning("ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
         // ç™»å‡ºï¼Œå›åˆ°ç™»å½•é¡µé¢
         clearToken();
         router.push("/login");
         // æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸, ä¸­æ–­è¯·æ±‚é“¾ã€‚
         return Promise.reject(new Error("ç™»å½•è¿‡æœŸ"));
       } else {
         // ä¸šåŠ¡å¤±è´¥ï¼ˆåç«¯è¿”å› code é 200ï¼‰
         ElMessage.error(msg || "è¯·æ±‚å¤±è´¥");
         return Promise.reject(new Error(msg || "Error")); // æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸
       }
     },
   
     // HTTP å±‚é¢é”™è¯¯å¤„ç†ï¼ˆè¶…æ—¶ã€401ã€500 ç­‰ï¼‰ï¼Œ  è¶…è¿‡200çŠ¶æ€ç çš„ä¼šè§¦å‘è¿™ä¸ªå‡½æ•°ï¼Œ
     (err) => {
       console.error("request error", err); // for debug
   
       const { response } = err;
       if (response) {
         ElMessage.error(err.message || "ç³»ç»Ÿå‡ºé”™");
       }
   
       return Promise.reject(err);
     }
   );
   ```

   æ‹¦æˆªå™¨ä¸­æ‹¦æˆªåˆ°çš„`response`çš„ç»“æ„æ˜¯ï¼š

   ```ts
   interface AxiosResponse<T = any> {
     data: T;              // åç«¯è¿”å›çš„ä¸šåŠ¡æ•°æ®ï¼ˆæ¯”å¦‚ { code, msg, data }ï¼‰
     status: number;       // HTTP çŠ¶æ€ç ï¼ˆæ¯”å¦‚ 200ã€404ï¼‰
     statusText: string;   // HTTP çŠ¶æ€æ–‡æœ¬ï¼ˆæ¯”å¦‚ OKã€Not Foundï¼‰
     headers: any;         // å“åº”å¤´
     config: InternalAxiosRequestConfig; // æœ¬æ¬¡è¯·æ±‚æ—¶çš„é…ç½®ï¼ˆè¯·æ±‚å¤´ã€å‚æ•°ã€url ç­‰ï¼‰
     request?: any;        // ä½å±‚è¯·æ±‚å¯¹è±¡ï¼ˆæµè§ˆå™¨ XMLHttpRequestã€Node.js httpï¼‰
   }
   ```

   è¯¦ç»†çš„ç»“æ„ï¼š

   ```json
   {
     "data": {
       "code": 200,
       "msg": "ok",
       "data": {
         "id": 1,
         "username": "å¼ ä¸‰"
       }
     },
     "status": 200,
     "statusText": "OK",
     "headers": {
       "content-type": "application/json; charset=utf-8"
     },
     "config": {
       "url": "/api/login",
       "method": "post",
       "headers": {...},
       "data": "{\"username\":\"admin\",\"password\":\"123456\"}",
       ...
     },
     "request": {...}
   }
   ```

   é€šå¸¸`response.data`è¿”å›çš„ç»“æ„æ˜¯ï¼š

   ```json
   {
       "code": 200,
       "msg": "ok",
       "data": {
         "id": 1,
         "username": "å¼ ä¸‰"
   }
   ```

   å…¶ä¸­çš„`code`æ˜¯åç«¯è‡ªå·±å®šä¹‰äº†ä¸šåŠ¡å­—æ®µï¼Œæ ¹æ®ä¸šåŠ¡é€»è¾‘æ¥è¿”å›ä¸åŒçš„çŠ¶æ€ç ï¼Œè¿™æ˜¯åç«¯æ¥è‡ªå®šä¹‰çš„ã€‚

   `data`å­—æ®µæ˜¯éœ€è¦çš„æ•°æ®

   **å®Œæ•´ä»£ç ï¼š**

   ```json
   import axios, { type InternalAxiosRequestConfig, type AxiosResponse } from "axios";
   import qs from "qs";
   import { getToken, isTokenExpired, clearToken } from "@/utils/auth";
   import router from "@/router";
   
   const instance = axios.create({
     baseURL: import.meta.env.VITE_APP_BASE_URL,
     timeout: 1000 * 10,
     headers: {
       "Content-Type": "application/json;charset=UTF-8",
     },
     paramsSerializer: (params) => qs.stringify(params),
   });
   
   // è¯·æ±‚æ‹¦æˆªå™¨
   const whiteList = ["/login", "/register"];
   
   instance.interceptors.request.use(
     (config: InternalAxiosRequestConfig) => {
       // è¯·æ±‚æ‹¦æˆªå™¨ä¸­ åˆ¤æ–­æ˜¯å¦å­˜åœ¨token,å¹¶æ·»åŠ åˆ°è¯·æ±‚å¤´ Authorization ä¸­
       // é€»è¾‘ä»£ç ,è·å–tokenï¼Œæ£€æŸ¥æ˜¯å¦è¿‡æœŸ
       const token = getToken();
       const isExpire = isTokenExpired();
   
       // èƒ½è·å–åˆ°tokençš„æƒ…å†µ
       if (token) {
         if (!isExpire) {
           config.headers.Authorization = `Bearer ${token}`;
           return config;
         } else {
           console.log("tokenè¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢");
           clearToken();
           router.push("/login");
           return Promise.reject(new Error("tokenè¿‡æœŸ"));
         }
       }
       // è·å–ä¸åˆ°tokenæƒ…å†µ
       else {
         if (whiteList.some((url) => config.url?.startsWith(url))) {
           return config; // ç™½åå•æ”¾è¡Œ
         } else {
           console.log("æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢");
           router.push("/login");
           return Promise.reject(new Error("æœªç™»å½•"));
         }
       }
     },
     (error) => {
       return Promise.reject(error);
     }
   );
   
   // å“åº”æ‹¦æˆªå™¨
   instance.interceptors.response.use(
     /* 
     HTTPçŠ¶æ€ç ï¼Œ2xx  æˆ– 3xx èŒƒå›´å†…çš„çŠ¶æ€ç éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°ã€‚
     æœåŠ¡å™¨æˆåŠŸè¿”å›äº†å“åº”ï¼ˆHTTP çŠ¶æ€ç ä¸º 2xx æˆ– 3xxï¼‰å°±ä¼šè§¦å‘ï¼Œå³ä½¿ä¸šåŠ¡ä¸Šæ˜¯å¤±è´¥çš„(æŒ‡åç«¯)
     */
     (response: AxiosResponse) => {
       // å¦‚æœå“åº”æ˜¯äºŒè¿›åˆ¶æµï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œç”¨äºä¸‹è½½æ–‡ä»¶ã€Excel å¯¼å‡ºç­‰
       if (response.config.responseType === "blob") {
         return response;
       }
   
       const { code, msg } = response.data;
       // åç«¯è¿”å›çš„code çŠ¶æ€ç 
       if (code === 200) {
         return response.data;
       } else if (code === 401) {
         ElMessage.warning("ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
         // ç™»å‡ºï¼Œå›åˆ°ç™»å½•é¡µé¢
         clearToken();
         router.push("/login");
         // æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸, ä¸­æ–­è¯·æ±‚é“¾ã€‚
         return Promise.reject(new Error("ç™»å½•è¿‡æœŸ"));
       } else {
         // ä¸šåŠ¡å¤±è´¥ï¼ˆåç«¯è¿”å› code é 200ï¼‰
         ElMessage.error(msg || "è¯·æ±‚å¤±è´¥");
         return Promise.reject(new Error(msg || "Error")); // æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸
       }
     },
   
     // HTTP å±‚é¢é”™è¯¯å¤„ç†ï¼ˆè¶…æ—¶ã€401ã€500 ç­‰ï¼‰ï¼Œ  è¶…è¿‡200çŠ¶æ€ç çš„ä¼šè§¦å‘è¿™ä¸ªå‡½æ•°ï¼Œ
     (err) => {
       console.error("request error", err); // for debug
   
       const { response } = err;
       if (response) {
         ElMessage.error(err.message || "ç³»ç»Ÿå‡ºé”™");
       }
   
       return Promise.reject(err);
     }
   );
   
   export default instance;
   ```

   

### è·¯ç”±å®ˆå«

åœ¨å®Œæˆäº†`token`å­˜å–ï¼Œå’Œ`axios`çš„å°è£…çš„åŸºç¡€ä¸Šï¼Œå°±å¯ä»¥åŠ å…¥åŠ¨æ€çš„è·¯ç”±æ³¨å†Œäº†ï¼Œè¿™ä¸€æ­¥éœ€è¦åœ¨ç”¨æˆ·ç™»å½•å®Œæˆä»¥åè¿›è¡Œã€‚



å¦‚æœtokenè¿‡æœŸäº†ï¼Œä½†æ˜¯æ²¡æœ‰æ¸…é™¤tokenï¼Œé™·å…¥æ­»å¾ªç¯ï¼Œç³»ç»Ÿå´©æºƒã€‚

tokenè¿‡æœŸäº†ï¼Œä½†æ˜¯å­˜åœ¨ï¼Œè·å–åˆ°ä»¥åï¼Œè¿›å…¥ `/` é‡å®šå‘åˆ° `/district-monitoring`ï¼ŒåŠ¨æ€è·¯ç”±æ³¨å†Œå®Œæˆï¼Œç›´æ¥æ”¾è¡Œäº†ã€‚

ç³»ç»Ÿå¯åŠ¨  http://localhost:3005/ ï¼Œè®¿é—®çš„æ˜¯ä¸æ˜¯ / ï¼Œæ˜¯ä¸æ˜¯å°±è§¦å‘äº† è·¯ç”±å®ˆå«ï¼ˆç›´æ¥å¯åŠ¨è®¿é—®/æ˜¯ä¸è§¦å‘è·¯ç”±å®ˆå«çš„ï¼‰ï¼Œæ”¾è¡Œä»¥åï¼Œæ‰è§¦å‘redirectï¼Œä¹‹åå†æ¬¡è§¦å‘äº†è·¯ç”±å®ˆå«ï¼Œæ˜¯ä¸æ˜¯è¿™æ ·çš„

ç„¶åä½ è®¿é—® `http://localhost:3005/`ï¼Œé‚£ä¹ˆå°†ä¼šçœ‹åˆ°å¦‚ä¸‹æµç¨‹ï¼š

1. é¦–å…ˆè¿›å…¥ `/`ï¼Œå®ˆå«è§¦å‘ä¸€æ¬¡ï¼Œ`to.fullPath` æ˜¯ `/`ï¼›
2. ç„¶åå› ä¸º `/` è·¯ç”±é…ç½®äº† `redirect`ï¼Œè‡ªåŠ¨é‡å®šå‘åˆ° `/district-monitoring`ï¼›
3. æ‰€ä»¥ä¼šå†æ¬¡è§¦å‘å®ˆå«ï¼Œ`to.fullPath` æ˜¯ `/district-monitoring`ã€‚



### layout

### redirect





#### æ— æ³•æ‰¾åˆ°æ¨¡å—â€œqsâ€çš„å£°æ˜æ–‡ä»¶

```shell
npm install -D @types/qs
```

#### ç”¨æˆ·æ´»åŠ¨ç›‘æ§ï¼ˆå¯é€‰ï¼‰

è®¾ç½®30åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨ç™»å‡º



ä¸€ä¸ªç™»å½•ç³»ç»Ÿçš„é€»è¾‘

åªè€ƒè™‘ä¸€ä¸ªJWT tokençš„æƒ…å†µï¼Œtokenè¿‡æœŸåç«¯ä¼šè¿”å›å¯¹åº”çš„çŠ¶æ€ç ï¼Œå‰ç«¯å°±æ˜¯è®©ç”¨æˆ·é‡æ–°ç™»å½•ã€‚

1. tokenå­˜å–æ–¹å¼
   1. è¿™é‡Œä½¿ç”¨localStorage + JSON ä¿å­˜
   2. ä¿å­˜çš„åŒæ—¶ä¿å­˜ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œå°±æ˜¯æ­¤åˆ»çš„æ—¶é—´æˆ³ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦è¿‡æœŸçš„
   3. æŠŠtokenå’Œæ—¶é—´æˆ³ä½œä¸ºä¸€ä¸ªå¯¹è±¡ä¸€èµ·å­˜å‚¨
2. axiosçš„å°è£…
3. é…ç½®loginç›¸å…³çš„api
4. é…ç½®userStoreçš„å±æ€§ä¸æ–¹æ³•
5. vueé¡µé¢ä¸­ä½¿ç”¨storeå®Œæˆç™»å½•é€»è¾‘



é…ç½®åŠ¨æ€è·¯ç”±

åç«¯è¿”å›çš„è·¯ç”±ç»“æ„ï¼š

```json

```

æ ¹æ®`component`å­—æ®µçš„è·¯å¾„ï¼Œé…ç½®æœ¬åœ°çš„è·¯ç”±ç›®å½•ã€‚

é…ç½®è·å–è·¯ç”±çš„`api`å’Œæ–¹æ³•



è·¯ç”±å®ˆå«ï¼š

æ¯æ¬¡è¿›è¡Œè·¯ç”±è·³è½¬æ—¶ï¼Œéƒ½ä¼šè§¦å‘è·¯ç”±å®ˆå«ï¼š`router.beforeEach`

è·¯ç”±å®ˆå«ä¸­åšä»€ä¹ˆï¼š

1. **è·å–tokenï¼Œåˆ¤æ–­æ˜¯å¦ç™»å½•ã€‚**

   **ç›®çš„**ï¼šæœ‰äº›é¡µé¢æ˜¯åªèƒ½ç™»å½•æ‰èƒ½è¿›å…¥çš„ã€‚å¦‚å›¾æ²¡æœ‰ç™»å½•ï¼Œåªèƒ½è®¿é—®ç™½åå•é¡µé¢æˆ–è€… å›åˆ°ç™»å½•é¡µã€‚

   **tokenå­˜åœ¨ï¼š**

   â€‹	åˆ¤æ–­è¿›å…¥çš„æ˜¯å¦æ˜¯ loginé¡µé¢ï¼š

   â€‹	è¿›å…¥loginé¡µé¢ï¼š

   â€‹		å·²ç»ç™»å½•äº†ï¼Œå°±ä¸è¦å†æ¬¡è¿›å…¥ç™»å½•é¡µé¢äº†ï¼Œç›´æ¥å›åˆ°  `/` 

   â€‹	ä¸è¿›å…¥loginé¡µé¢ï¼š

   â€‹		å»å…¶å®ƒé¡µé¢,å°±è¦åˆ¤æ–­åŠ¨æ€è·¯ç”±æœ‰æ²¡æœ‰æ³¨å†Œå®Œæˆ

â€‹		**tokenä¸å­˜åœ¨ï¼š**

â€‹		è¦ä¸è¦æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸï¼Ÿ

â€‹			ä¸ç”¨æ£€æŸ¥ã€‚å³ä½¿tokenè¿‡æœŸäº†ï¼Œè¿›å…¥é¡µé¢ä»¥åï¼Œè‚¯å®šä¼šè§¦å‘ç½‘ç»œè¯·æ±‚ï¼Œåœ¨ç½‘ç»œè¯·æ±‚ä¸­ï¼Œä¼šæ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸã€‚

2. **å»å…¶å®ƒé¡µé¢ï¼š**

   

### æ— é™é‡å®šå‘é—®é¢˜:

####  next() ä¸ next(route)ã€‚

åœ¨è·¯ç”±å®ˆå«ä¸­ï¼ŒbeforeEaché’©å­ä¸­è¿›è¡Œæ‹¦æˆªï¼Œ

```js
// å…³é”®ä»£ç 
if (permissionStore.isRoutesLoaded) {
    // next();
    // è¿™ä¸ªè§¦å‘äº†æ— é™é‡å®šå‘
    next({ ...to, replace: true });
}
```

æŠ¥é”™ï¼š

```
Detected a possibly infinite redirection in a navigation guard when going from "/" to "/district-monitoring". Aborting to avoid a Stack Overflow.
Are you always returning a new location within a navigation guard? That would lead to this error. Only return when redirecting or aborting, that should fix this. This might break in production if not fixed.
```

```js
next();
// è¿™ä¸ªè§¦å‘äº†æ— é™é‡å®šå‘
// next({ ...to, replace: true });
åŒºåˆ«æ˜¯ä»€ä¹ˆï¼š
```

åœ¨Vue Routerçš„å¯¼èˆªå®ˆå«ä¸­ï¼Œ

â€‹	å½“ä½ ä½¿ç”¨ `next()` æ—¶ï¼Œå®ƒä¼šç»§ç»­å¯¼èˆªåˆ°ç›®æ ‡è·¯ç”±ï¼Œä¸ä¼šè§¦å‘æ–°çš„å¯¼èˆªï¼Œ**ä¹Ÿä¸ä¼šå†æ¬¡è°ƒç”¨è·¯ç”±å®ˆå«**

â€‹	ä½†å½“ä½ ä½¿ç”¨ `next(route)` æ—¶ï¼Œå®ƒä¼š**ä¸­æ–­å½“å‰å¯¼èˆªå¹¶å¼€å§‹ä¸€ä¸ªæ–°çš„å¯¼èˆª**ï¼Œå³ä½¿æ–°çš„ç›®æ ‡ä¸å½“å‰ç›®æ ‡ç›¸åŒã€‚**å†æ¬¡è§¦å‘æ‰€æœ‰å¯¼èˆªå®ˆå«**

ä» "/" é‡å®šå‘åˆ° "/district-monitoring" æ—¶ï¼š

1. é¦–å…ˆï¼Œè·¯ç”±é…ç½®ä¸­çš„é‡å®šå‘ç”Ÿæ•ˆï¼Œå°†è·¯å¾„ä» "/" æ”¹ä¸º "/district-monitoring"
2. è¿™è§¦å‘äº†è·¯ç”±å®ˆå« router.beforeEach
3. åœ¨å®ˆå«ä¸­æ£€æŸ¥åˆ°ç”¨æˆ·å·²ç™»å½•ä¸”è·¯ç”±å·²åŠ è½½ (permissionStore.isRoutesLoaded ä¸º true)
4. ç„¶åæ‰§è¡Œ next({ ...to, replace: true })

é—®é¢˜å°±å‡ºåœ¨è¿™ä¸€æ­¥ï¼š

- next({ ...to, replace: true }) å®é™…ä¸Šæ˜¯åœ¨è¯´"ä¸­æ–­å½“å‰å¯¼èˆªï¼Œå¼€å§‹ä¸€ä¸ªæ–°çš„å¯¼èˆªåˆ°åŒæ ·çš„åœ°å€"
- è¿™ç›¸å½“äºå†æ¬¡å¯¼èˆªåˆ° "/district-monitoring"ï¼Œå³ä½¿ç”¨æˆ·å·²ç»åœ¨å¯¼èˆªåˆ°è¿™ä¸ªåœ°å€çš„è¿‡ç¨‹ä¸­
- è¿™å°±è§¦å‘äº†æ–°ä¸€è½®çš„å¯¼èˆªè¿‡ç¨‹ï¼Œå†æ¬¡è°ƒç”¨è·¯ç”±å®ˆå«
- ç”±äºæ¡ä»¶æ²¡å˜ï¼Œå®ˆå«ä¼šå†æ¬¡æ‰§è¡Œ next({ ...to, replace: true })

- å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œå½¢æˆæ— é™å¾ªç¯





login - > / - > 

![image-20250425104057856](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20250425104057856.png)



æ’æŸ¥ï¼š

if...else...çš„é€»è¾‘ï¼Œåœ¨ä¸åŒçš„é€»è¾‘ä»£ç ä¸­è¾“å‡ºï¼Œç¡®å®è¿›åˆ°å“ªä¸ªä»£ç å—ï¼Œç»“åˆæ§åˆ¶å°è¾“å‡ºè°ƒè¯•ã€‚



å‡å¦‚ç”¨æˆ·ç™»å½•äº†ç³»ç»Ÿï¼Œåœ¨æŸä¸€ä¸ªé¡µé¢ä¸­åœç•™è¿‡é•¿ï¼Œå¯¼è‡´tokenè¿‡æœŸäº†ï¼Œä½†æ˜¯æ²¡æœ‰åˆ é™¤æ‰ï¼Œå½“ç”¨æˆ·åˆ·æ–°é¡µé¢æ—¶ã€‚

è§¦å‘è·¯ç”±å®ˆå«ï¼Œå­˜åœ¨tokenï¼Œä¹Ÿå®Œæˆäº†è·¯ç”±æ³¨å†Œï¼Œç›´æ¥æ”¾è¡Œã€‚

è§¦å‘ç½‘ç»œè¯·æ±‚æ‹¦æˆªï¼Œæ£€æŸ¥äº†tokenè¿‡æœŸï¼Œç›´æ¥æ‰“å›åˆ° /loginï¼Œå†æ¬¡è§¦å‘è·¯ç”±å®ˆå«

è·¯ç”±å®ˆå«å‘ç°ï¼Œtokenè¿˜æ˜¯å­˜åœ¨çš„ï¼Œå·²ç»ç™»å½•äº†ï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥åˆ°loginé¡µé¢ï¼Œè¿›å…¥åˆ° / 

äº§ç”Ÿæ­»å¾ªç¯ã€‚

è§£å†³ï¼š

è·¯ç”±å®ˆå«ä¸­ä¹Ÿè¦æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸè¦æ¸…é™¤tokenã€‚



æœ€ä½³å®è·µæ˜¯åœ¨å¤šä¸ªå±‚é¢å¤„ç†tokenè¿‡æœŸé—®é¢˜ï¼š

1. è·¯ç”±å®ˆå«ä¸­æ£€æŸ¥ï¼Œé˜²æ­¢ç”¨æˆ·è®¿é—®éœ€è¦è®¤è¯çš„é¡µé¢

1. è¯·æ±‚æ‹¦æˆªå™¨ä¸­æ£€æŸ¥ï¼Œé˜²æ­¢å‘é€æ— æ•ˆè¯·æ±‚

1. å“åº”æ‹¦æˆªå™¨ä¸­å¤„ç†401/403å“åº”ï¼Œæ¸…é™¤æ— æ•ˆtokenå¹¶é‡å®šå‘





å…¶å®ƒé—®é¢˜

![image-20250424194845022](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20250424194845022.png)

### éš§é“ç«™ç‚¹ç‚¹å‡»çš„æ¥å£ï¼š

#### ç«™ç‚¹ä¿¡æ¯ï¼š

![image-20250709181940261](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20250709181940261.png)

![image-20250709182308221](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20250709182308221.png)



![image-20250709182355973](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20250709182355973.png)

#### é¢„è­¦åˆ—è¡¨ï¼š

![image-20250709182123129](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20250709182123129.png)

#### æ°´ä½ç»Ÿè®¡å›¾ï¼š

![image-20250709181646028](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20250709181646028.png)
