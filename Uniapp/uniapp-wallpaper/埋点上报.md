### ğŸ“Œ ä»€ä¹ˆæ˜¯åŸ‹ç‚¹ä¸ŠæŠ¥

**åŸ‹ç‚¹ï¼ˆTracking Pointï¼‰** æŒ‡çš„æ˜¯åœ¨ä»£ç é‡Œäººä¸ºåŠ ä¸Šä¸€äº›â€œè®°å½•ç”¨æˆ·è¡Œä¸ºâ€çš„ä»£ç é€»è¾‘ï¼Œç„¶åæŠŠè¿™äº›è¡Œä¸ºæ•°æ®å‘é€ï¼ˆä¸ŠæŠ¥ï¼‰åˆ°æœåŠ¡å™¨ã€‚

æ¯”å¦‚ï¼š

- ç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªæŒ‰é’®
- ç”¨æˆ·ä¸‹è½½äº†ä¸€å¼ å›¾ç‰‡
- ç”¨æˆ·åœç•™åœ¨æŸä¸ªé¡µé¢å¤šä¹…
- ç”¨æˆ·æ”¯ä»˜æˆåŠŸ

è¿™äº›æ•°æ®å¯¹ **äº§å“ã€è¿è¥ã€ä¸šåŠ¡åˆ†æ** éå¸¸æœ‰ç”¨ã€‚



### ğŸ“Œ åº”ç”¨åœºæ™¯

1. **ç”¨æˆ·è¡Œä¸ºåˆ†æ**
   - æ¯”å¦‚ã€Œæ¯å¤©æœ‰å¤šå°‘äººç‚¹å‡»ä¸‹è½½æŒ‰é’®ã€
   - ã€Œå“ªå¼ å›¾ç‰‡æœ€å—æ¬¢è¿ã€
   - ã€ŒæŸä¸ªåŠŸèƒ½ä½¿ç”¨ç‡æ˜¯å¤šå°‘ã€
2. **ä¸šåŠ¡ç»Ÿè®¡ / è®¡è´¹**
   - åƒä½ ç°åœ¨çš„ `downloadPicApi`ï¼Œå°±å¯èƒ½ç”¨äºç»Ÿè®¡å›¾ç‰‡çš„ä¸‹è½½é‡
   - å¦‚æœè¿™äº›å›¾ç‰‡æ˜¯æ”¶è´¹çš„ï¼Œè¿˜å¯èƒ½è·Ÿæ”¶å…¥æŒ‚é’©
3. **AB æµ‹è¯•**
   - å‘å¸ƒä¸¤ä¸ªç‰ˆæœ¬çš„é¡µé¢ï¼Œç»Ÿè®¡å“ªä¸ªç‰ˆæœ¬çš„è½¬åŒ–ç‡æ›´é«˜
   - é€šè¿‡åŸ‹ç‚¹åˆ¤æ–­æœ€ç»ˆé‡‡ç”¨å“ªä¸ªæ–¹æ¡ˆ
4. **é—®é¢˜ç›‘æ§ / æ—¥å¿—åˆ†æ**
   - ç»Ÿè®¡æ¥å£å¤±è´¥ç‡ã€é¡µé¢æŠ¥é”™æ•°
   - åˆ†ææŸä¸ªåŠŸèƒ½æ˜¯ä¸æ˜¯æœ‰ bug



### ğŸ“Œ ä¸¾ä¸ªä¾‹å­

ä½ ç°åœ¨çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

```js
// ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œ
await saveImageToAlbum(imgInfo.path);
// ç„¶åä¸ŠæŠ¥
downloadPicApi({ picId });
```

è¿™é‡Œçš„ `downloadPicApi` å°±æ˜¯ä¸€ä¸ªåŸ‹ç‚¹ä¸ŠæŠ¥æ¥å£ï¼š

- ç”¨æˆ·ä¸‹è½½äº†å›¾ç‰‡ â†’ ä¸ŠæŠ¥åˆ°åå°
- åå°å¯ä»¥çŸ¥é“è¿™å¼ å›¾ç‰‡è¢«ä¸‹è½½äº†å¤šå°‘æ¬¡ã€è°ä¸‹è½½çš„

å¦‚æœä¸åšè¿™ä¸ªä¸ŠæŠ¥ï¼Œåå°å°±å®Œå…¨ä¸çŸ¥é“ç”¨æˆ·çš„è¡Œä¸ºã€‚



### ğŸ“Œ æ€»ç»“

- **åŸ‹ç‚¹**ï¼šåœ¨å…³é”®è¡Œä¸ºå¤„æ’å…¥ä¸ŠæŠ¥ä»£ç ã€‚
- **ä¸ŠæŠ¥**ï¼šæŠŠåŸ‹ç‚¹æ•°æ®å‘é€åˆ°åå°ï¼Œä¾›åˆ†æ/ç»Ÿè®¡/è®¡è´¹ã€‚
- **åº”ç”¨**ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æã€è®¡è´¹ç»Ÿè®¡ã€ABæµ‹è¯•ã€ç›‘æ§ã€‚



### åŸ‹ç‚¹ä¸ŠæŠ¥å®ç°

#### 1. å·¥å…·å‡½æ•°å®ç°

`// utils/track.js`

```js
// ä¸ŠæŠ¥åŸ‹ç‚¹çš„æ ¸å¿ƒå‡½æ•°
async function sendReport(apiFn, params) {
  try {
    await apiFn(params); // ç¬¬ä¸€æ¬¡å°è¯•
  } catch (err) {
    console.warn("åŸ‹ç‚¹ä¸ŠæŠ¥å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•...", err);
    try {
      await apiFn(params); // é‡è¯•ä¸€æ¬¡
    } catch (err2) {
      console.error("åŸ‹ç‚¹é‡è¯•å¤±è´¥ï¼Œç¼“å­˜åˆ°æœ¬åœ°", err2);
      cacheReport({ apiFnName: apiFn.name, params });
    }
  }
}

// ç¼“å­˜å¤±è´¥çš„åŸ‹ç‚¹ï¼ˆå­˜åˆ°æœ¬åœ°ï¼‰
function cacheReport(data) {
  const key = "pendingReports";
  const reports = uni.getStorageSync(key) || [];
  reports.push({ ...data, time: Date.now() });
  uni.setStorageSync(key, reports);
}

// é‡æ–°å‘é€ç¼“å­˜çš„åŸ‹ç‚¹
async function flushReports(apiMap) {
  const key = "pendingReports";
  const reports = uni.getStorageSync(key) || [];

  if (!reports.length) return;

  const successReports = [];
  for (const item of reports) {
    const apiFn = apiMap[item.apiFnName];
    if (!apiFn) continue; // æ‰¾ä¸åˆ°å¯¹åº”æ¥å£å°±è·³è¿‡
    try {
      await apiFn(item.params);
      successReports.push(item);
    } catch (err) {
      console.warn("è¡¥å‘å¤±è´¥", err);
    }
  }

  // æŠŠæˆåŠŸçš„ç§»é™¤
  const remain = reports.filter((r) => !successReports.includes(r));
  uni.setStorageSync(key, remain);
}

export default {
  sendReport,
  flushReports,
};
```

è¿™é‡Œç¼“å­˜å‡½æ•°åˆ°æœ¬åœ°æ—¶ï¼Œç¼“å­˜çš„ä»…ä»…æ˜¯å‡½æ•°çš„åç§°ï¼Œä¸æ˜¯å‡½æ•°æœ¬èº«

```js
 cacheReport({ apiFnName: apiFn.name, params });
```

å®é™…ä¸Šï¼Œä½†åœ¨ **JavaScript/uniapp ç¯å¢ƒé‡ŒæŠŠå‡½æ•°æœ¬èº«ç¼“å­˜åˆ°æœ¬åœ°å­˜å‚¨**ï¼ˆ`localStorage` / `uni.setStorageSync`ï¼‰æ˜¯è¡Œä¸é€šçš„ã€‚

**å‡½æ•°ä¸èƒ½è¢«åºåˆ—åŒ–**

`uni.setStorageSync` / `localStorage` åº•å±‚å…¶å®æ˜¯ **å­—ç¬¦ä¸²å­˜å‚¨**ã€‚

ä½ å¾€é‡Œé¢å­˜å¯¹è±¡æ—¶ï¼Œå®ƒä¼šå…ˆ `JSON.stringify`ï¼Œä½†å‡½æ•°åœ¨ JSON é‡Œä¼šè¢«ä¸¢å¼ƒã€‚

```js
JSON.stringify({ fn: () => {} }) // => "{}"
```

æ‰€ä»¥å‡½æ•°æ— æ³•ç›´æ¥å­˜è¿›å»ï¼Œå†å–å‡ºæ¥çš„æ—¶å€™å°±ä¸¢å¤±äº†ã€‚



æ‰€ä»¥åœ¨ä½¿ç”¨`flushReports`æ—¶ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªæ˜ å°„è¡¨ï¼Œå³`å‡½æ•°åç§°ï¼šå‡½æ•°æœ¬èº«`ï¼Œè¿™æ ·çš„ä¸€ä¸ªæ˜ å°„è¡¨ï¼Œæ ¹æ®å‡½æ•°åç§°è·å–å‡½æ•°æœ¬èº«ï¼Œç„¶åè°ƒç”¨ã€‚

#### 2. ä½¿ç”¨æ–¹å¼

å‡è®¾ä½ æœ‰ä¸€ä¸ªæ¥å£ï¼š

```js
// api.js
export function downloadPicApi(params) {
  return new Promise((resolve, reject) => {
    uni.request({
      url: "https://example.com/api/download",
      method: "POST",
      data: params,
      success: (res) => {
        if (res.statusCode === 200) resolve(res.data);
        else reject(new Error("æ¥å£è¿”å›é”™è¯¯"));
      },
      fail: reject,
    });
  });
}
```

åœ¨ä¸šåŠ¡ä»£ç é‡Œè°ƒç”¨ï¼š

```js
import Track from "@/utils/track";
import { downloadPicApi } from "@/api";

// å›¾ç‰‡ä¿å­˜æˆåŠŸåè°ƒç”¨
Track.sendReport(downloadPicApi, { picId: 123 });
```

#### 3. åœ¨åˆé€‚çš„æ—¶æœºè¡¥å‘ç¼“å­˜

æ¯”å¦‚åœ¨ `App.vue` çš„ `onLaunch` é‡Œè°ƒç”¨ä¸€æ¬¡ï¼š

```js
import Track from "@/utils/track";
import { downloadPicApi } from "@/api";

export default {
  onLaunch() {
    // è¡¥å‘æœ¬åœ°ç¼“å­˜çš„åŸ‹ç‚¹
    Track.flushReports({
      downloadPicApi,
    });
  },
};
```

```js
// è¿™é‡Œçš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°æ˜ å°„è¡¨ï¼Œ{ downloadPicApi : downloadPicApi },
Track.flushReports({
	downloadPicApi,
});
```



### âœ… æ•ˆæœ

1. **æ­£å¸¸æƒ…å†µ**ï¼šä¿å­˜æˆåŠŸ â†’ ä¸ŠæŠ¥æˆåŠŸã€‚
2. **æ¥å£å¤±è´¥**ï¼šé‡è¯•ä¸€æ¬¡ï¼Œå¦‚æœè¿˜å¤±è´¥ â†’ ç¼“å­˜åˆ°æœ¬åœ°ã€‚
3. **ä¸‹æ¬¡å¯åŠ¨ App / å°ç¨‹åº**ï¼šä¼šè‡ªåŠ¨æŠŠç¼“å­˜çš„åŸ‹ç‚¹é‡æ–°ä¸ŠæŠ¥ã€‚





### ğŸ“Œ å¸¸è§å¯¼è‡´åŸ‹ç‚¹å¤±è´¥çš„æƒ…å†µ

#### 1. **ç½‘ç»œé—®é¢˜**

- ç”¨æˆ·å½“å‰æ— ç½‘ç»œ / ç½‘ç»œåˆ‡æ¢ï¼ˆWiFi â†’ 4Gï¼‰
- å¼±ç½‘ç¯å¢ƒï¼ˆå»¶è¿Ÿé«˜ï¼Œè¶…æ—¶ï¼‰
- ç”¨æˆ·çªç„¶æ–­ç½‘ï¼ˆé”å±ã€é£è¡Œæ¨¡å¼ã€App é€€åå°ï¼‰

ğŸ‘‰ æœ€å¸¸è§çš„å¤±è´¥åŸå› ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¦åšç¼“å­˜ã€‚





#### 2. **æœåŠ¡ç«¯é—®é¢˜**

- æ¥å£æŒ‚æ‰ / 502 / 503 / 500
- åŸŸåè§£æå¤±è´¥ / CDN æ•…éšœ
- æœåŠ¡ç«¯é™æµï¼ˆé«˜å³°æœŸå¯èƒ½ç›´æ¥ä¸¢è¯·æ±‚ï¼‰

ğŸ‘‰ è¿™ç±»å¤±è´¥ä¸€èˆ¬æ˜¯å…¨å±€æ€§çš„ï¼Œä½ çš„åŸ‹ç‚¹å¾ˆå¯èƒ½éœ€è¦ç­‰æœåŠ¡ç«¯æ¢å¤å†è¡¥å‘ã€‚



#### 3. **CORS / è·¨åŸŸé—®é¢˜ï¼ˆH5 ç‰¹æœ‰ï¼‰**

- å‰ç«¯è¯·æ±‚çš„åŸ‹ç‚¹æ¥å£ï¼Œåç«¯æ²¡é…ç½® `Access-Control-Allow-Origin`ã€‚
- æœ¬åœ°å¼€å‘ç”¨ `http://192.168.x.x`ï¼Œç”Ÿäº§æ˜¯ `https://xxx.com`ï¼Œåç«¯æ²¡å…è®¸è·¨åŸŸã€‚

ğŸ‘‰ ä½ å‰å‡ å¤©é‡åˆ°çš„ `CORS policy blocked` å°±å±äºè¿™ç§æƒ…å†µã€‚



#### 4. **å°ç¨‹åº / App ç‰¹æ®Šé™åˆ¶**

- å°ç¨‹åºè¯·æ±‚åŸŸåæ²¡æœ‰åœ¨åå°é…ç½®ç™½åå•ã€‚
- App åˆšå¯åŠ¨ã€WebView ç¯å¢ƒè¿˜æ²¡åˆå§‹åŒ–ï¼Œå¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚
- éƒ¨åˆ†å¹³å°ï¼ˆæ¯”å¦‚å¾®ä¿¡å°ç¨‹åºï¼‰å¯¹è¯·æ±‚æœ‰å¹¶å‘æ•°é™åˆ¶ï¼ˆåŒæ—¶æœ€å¤š 10 ä¸ª requestï¼‰ã€‚



#### 5. **åŸ‹ç‚¹æ•°æ®æ ¼å¼é—®é¢˜**

- å‰ç«¯ä¼ çš„å‚æ•°ä¸ç¬¦åˆåç«¯è¦æ±‚ï¼Œå¯¼è‡´è¢« rejectã€‚
- åç«¯è¿”å›é 200 çŠ¶æ€ç ï¼ˆæ¯”å¦‚ 400/401/403ï¼‰ã€‚
- JSON æ ¼å¼é”™è¯¯ / ä¹±ç ã€‚

ğŸ‘‰ è¿™æ—¶å€™é”™è¯¯å±äºã€Œå¯é¢„æœŸå¤±è´¥ã€ï¼Œé€šå¸¸éœ€è¦ä¸šåŠ¡ä¿®æ­£ã€‚



#### 6. **ç”¨æˆ·è¡Œä¸ºå¯¼è‡´**

- ç”¨æˆ·ç‚¹å‡»äº†ä¸‹è½½ï¼Œä½†ç¬é—´å…³é—­é¡µé¢ / é€€åå° â†’ è¯·æ±‚è¢«ä¸­æ–­ã€‚
- ç”¨æˆ·æ‰‹åŠ¨å–æ¶ˆæˆæƒï¼ˆæ¯”å¦‚ä¿å­˜åˆ°ç›¸å†Œæ—¶æ‹’ç»æˆæƒï¼‰ï¼Œå¯¼è‡´åŸ‹ç‚¹é€»è¾‘æ²¡èµ°ä¸‹å»ã€‚



#### ğŸ“Œ æ€»ç»“

å¯¼è‡´åŸ‹ç‚¹å¤±è´¥çš„ä¸»è¦åŸå› å¯ä»¥å½’ç±»ä¸ºä¸‰ç±»ï¼š

1. **å‰ç«¯ç¯å¢ƒä¸ç¨³å®š**
   - ç½‘ç»œæ–­å¼€ã€App é€€åå°ã€å°ç¨‹åºé™åˆ¶ã€‚
2. **åç«¯æœåŠ¡ä¸ç¨³å®š**
   - æ¥å£æŒ‚äº†ã€è·¨åŸŸé—®é¢˜ã€é™æµã€‚
3. **ä¸šåŠ¡é€»è¾‘é—®é¢˜**
   - å‚æ•°é”™è¯¯ã€æƒé™ä¸è¶³ã€ç”¨æˆ·å–æ¶ˆæ“ä½œã€‚

ğŸ‘‰ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼š

- åŸ‹ç‚¹é€šå¸¸ **ä¸é˜»å¡ä¸»æµç¨‹**ï¼ˆæ¯”å¦‚ä¿å­˜æˆåŠŸç…§æ ·æç¤ºç”¨æˆ·ï¼‰ã€‚
- è¦æœ‰ **é‡è¯• + ç¼“å­˜è¡¥å‘** æœºåˆ¶ã€‚



### åŸ‹ç‚¹å¤±è´¥åœºæ™¯ â†’ åº”å¯¹ç­–ç•¥è¡¨æ ¼

| **å¤±è´¥åœºæ™¯**            | **åŸå› æè¿°**                                 | **ä¸šåŠ¡å½±å“**         | **åº”å¯¹ç­–ç•¥**                                                 |
| ----------------------- | -------------------------------------------- | -------------------- | ------------------------------------------------------------ |
| **ç½‘ç»œé—®é¢˜**            | ç”¨æˆ·æ–­ç½‘ã€å¼±ç½‘ã€é£è¡Œæ¨¡å¼åˆ‡æ¢ã€App é€€åå°     | è¯·æ±‚å¤±è´¥ï¼Œæ•°æ®æœªä¸ŠæŠ¥ | - æœ¬åœ°ç¼“å­˜å¤±è´¥åŸ‹ç‚¹  - ç½‘ç»œæ¢å¤æˆ–å®šæ—¶å™¨è‡ªåŠ¨è¡¥å‘  - å¯åŠ é‡è¯•æœºåˆ¶ |
| **æœåŠ¡ç«¯æ•…éšœ**          | æ¥å£æŒ‚æ‰ã€è¿”å› 5xxã€CDN / DNS é—®é¢˜           | è¯·æ±‚å¤±è´¥ï¼Œä¸ŠæŠ¥å¤±è´¥   | - é‡è¯•ä¸€æ¬¡æˆ–å¤šæ¬¡  - æœ¬åœ°ç¼“å­˜ç­‰å¾…ä¸‹æ¬¡è¡¥å‘  - è®°å½•æ—¥å¿—ä¾¿äºè¿ç»´æ’æŸ¥ |
| **è·¨åŸŸ / CORS**         | H5 åŸŸåæœªé…ç½®è·¨åŸŸå…è®¸                        | æµè§ˆå™¨ç›´æ¥é˜»æ­¢è¯·æ±‚   | - åç«¯æ­£ç¡®é…ç½® `Access-Control-Allow-Origin`  - æœ¬åœ°å¼€å‘æ—¶ä½¿ç”¨ä»£ç† |
| **å°ç¨‹åº / App é™åˆ¶**   | åŸŸåæœªç™½åå•ã€å¹¶å‘è¯·æ±‚é™åˆ¶ã€WebView æœªåˆå§‹åŒ– | è¯·æ±‚å¤±è´¥ï¼Œä¸ŠæŠ¥å¤±è´¥   | - ç¡®ä¿æ¥å£åœ¨å°ç¨‹åºåå°/manifest é…ç½®ç™½åå•  - æ§åˆ¶å¹¶å‘è¯·æ±‚  - ç­‰å¾…ç¯å¢ƒåˆå§‹åŒ–åå†å‘é€ |
| **æ•°æ®æ ¼å¼é”™è¯¯**        | å‚æ•°ç¼ºå¤±ã€æ ¼å¼ä¸ç¬¦ã€JSON é”™è¯¯                | è¯·æ±‚è¢«æœåŠ¡ç«¯æ‹’ç»     | - å‰ç«¯æ ¡éªŒå‚æ•°  - ä¿®æ­£è¯·æ±‚æ•°æ®  - ä¸ç¼“å­˜ï¼Œç›´æ¥ä¸¢å¼ƒ           |
| **ç”¨æˆ·è¡Œä¸ºå¯¼è‡´**        | ç”¨æˆ·å–æ¶ˆæ“ä½œã€æ‹’ç»æƒé™ã€é¡µé¢å…³é—­             | è¯·æ±‚æœªå‘é€æˆ–ä¸­æ–­     | - ä¸šåŠ¡ä¸Šæ— éœ€è¡¥å‘ï¼ˆæ¯”å¦‚ç”¨æˆ·å–æ¶ˆä¸‹è½½ï¼‰  - å¯¹å…³é”®è¡Œä¸ºï¼Œå¯æç¤ºé‡è¯•æˆ–è®°å½•å¤±è´¥çŠ¶æ€ |
| **æ¥å£é™æµ / æƒé™ä¸è¶³** | é«˜å³°æœŸæ¥å£è¿”å› 429 / æœªæˆæƒ                  | ä¸ŠæŠ¥å¤±è´¥             | - æœ¬åœ°ç¼“å­˜å¤±è´¥è¯·æ±‚  - ç­‰å¾…ä¸‹ä¸€æ¬¡æœºä¼šè¡¥å‘  - å¯é€‚å½“é™ä½å‘é€é¢‘ç‡ |

#### ğŸ“Œ ä½¿ç”¨å»ºè®®

1. **ç¼“å­˜è¡¥å‘ä¼˜å…ˆå¤„ç†**ï¼šé’ˆå¯¹ç½‘ç»œé—®é¢˜ã€æœåŠ¡ç«¯æ•…éšœã€æ¥å£é™æµç­‰å¯æ¢å¤æƒ…å†µã€‚
2. **ä¸ç¼“å­˜å¯é¢„æœŸå¤±è´¥**ï¼šç”¨æˆ·å–æ¶ˆã€å‚æ•°é”™è¯¯ç­‰å¯ç›´æ¥ä¸¢å¼ƒæˆ–æç¤ºç”¨æˆ·ã€‚
3. **ç»Ÿä¸€å°è£…åŸ‹ç‚¹å·¥å…·**ï¼šåƒå‰é¢å†™çš„ `Track.sendReport` + `flushReports`ï¼Œä¿è¯ä¸»æµç¨‹ä¸å—é˜»ç¢ã€‚
4. **æ—¥å¿—è®°å½•**ï¼šè¡¥å‘å¤±è´¥å¯ä»¥æ‰“å°æ—¥å¿—ï¼Œä¾¿äºè¿ç»´æˆ–åˆ†æé—®é¢˜ã€‚





### **åŸ‹ç‚¹å¤±è´¥åˆ†ä¸¤ç§**ï¼š

1. **å¯æ¢å¤å¤±è´¥**ï¼ˆç½‘ç»œé—®é¢˜ã€æœåŠ¡ç«¯æŒ‚äº†ã€é™æµï¼‰ â†’ âœ… åº”è¯¥ç¼“å­˜ï¼Œç­‰å¾…è¡¥å‘ã€‚
2. **ä¸å¯æ¢å¤å¤±è´¥**ï¼ˆå‰ç«¯å‚æ•°é”™è¯¯ã€ä¸šåŠ¡é€»è¾‘ä¸æˆç«‹ï¼‰ â†’ âŒ ä¸åº”è¯¥ç¼“å­˜ï¼Œç›´æ¥ä¸¢å¼ƒã€‚

æ‰€ä»¥ï¼Œ`sendReport` é‡Œéœ€è¦åœ¨ **å¤±è´¥æ˜¯åŒºåˆ†é”™è¯¯ç±»å‹**ï¼Œä¸æ˜¯æ‰€æœ‰å¤±è´¥éƒ½è¿›ç¼“å­˜ã€‚

#### ğŸ“Œ æ”¹è¿›åçš„ `sendReport`

```js
async function sendReport(apiFn, params) {
    try {
        await apiFn(params); // ç¬¬ä¸€æ¬¡å°è¯•
    } catch (err) {
        console.warn("åŸ‹ç‚¹ä¸ŠæŠ¥å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•...", err);
        // åˆ¤æ–­æ˜¯å¦ä¸ºâ€œå¯æ¢å¤å¤±è´¥â€
        if (isRetryableError(err)) {
            try {
                await apiFn(params); // å†é‡è¯•ä¸€æ¬¡
            } catch (err2) {
                console.error(`[åŸ‹ç‚¹] é‡è¯•å¤±è´¥ï¼Œå†™å…¥ç¼“å­˜: ${apiFn.name}`, err2);
                cacheReport({ apiFnName: apiFn.name, params });
            }
        } else {
            console.error(`[åŸ‹ç‚¹] ä¸å¯æ¢å¤å¤±è´¥ï¼Œä¸¢å¼ƒ: ${apiFn.name}`, err);
        }

    }
}
```

#### ğŸ“Œ è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­é”™è¯¯ç±»å‹

ä½ å¯ä»¥å°è£…ä¸€ä¸ª `isRetryableError` æ¥åŒºåˆ†é”™è¯¯ï¼š

```js
function isRetryableError(err) {
  if (!err) return false;

  // ç½‘ç»œé—®é¢˜ / è¶…æ—¶
  if (err.errMsg && err.errMsg.includes("request:fail")) return true;

  // HTTP çŠ¶æ€ç 
  if (err.statusCode) {
    if (err.statusCode >= 500) return true; // æœåŠ¡ç«¯é”™è¯¯ï¼Œå¯é‡è¯•
    if (err.statusCode === 429) return true; // é™æµï¼Œå¯é‡è¯•
    return false; // 4xx å‚æ•°é”™è¯¯ç­‰ï¼Œç›´æ¥ä¸¢å¼ƒ
  }

  return false; // é»˜è®¤ä¸å¯é‡è¯•
}
```

#### âœ… è¿™æ ·æ”¹è¿›å

- ç½‘ç»œå¤±è´¥ã€æœåŠ¡å™¨æŒ‚äº†ã€é™æµ â†’ ä¼šç¼“å­˜å¹¶è¡¥å‘ã€‚
- å‚æ•°é”™è¯¯ã€ä¸šåŠ¡é€»è¾‘é”™è¯¯ â†’ ä¸ä¼šç¼“å­˜ï¼Œé¿å…æ— æ„ä¹‰è¯·æ±‚å ç”¨ç©ºé—´ã€‚





æœ€ç»ˆç‰ˆæœ¬ï¼š`track.js`

```js
// åŸ‹ç‚¹ä¸ŠæŠ¥å·¥å…·å‡½æ•°;
const STORAGE_KEY = "pendingReports";

/**
 * åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯æ¢å¤
 * åŒºåˆ†ã€Œå¯æ¢å¤é”™è¯¯ã€å’Œã€Œä¸å¯æ¢å¤é”™è¯¯ã€
 * å¯æ¢å¤çš„æ‰ç¼“å­˜å¹¶è¡¥å‘ï¼Œä¸å¯æ¢å¤çš„ç›´æ¥ä¸¢å¼ƒ
 * æ ¹æ®å®é™…çš„åç«¯ä¸šåŠ¡é€»è¾‘å†™ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå¹¶ä¸”åœ¨sendReportä¸­æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªå‡½æ•°
 * @param {Object} err
 */
function isRetryableError(err) {
  if (!err) return false;

  // uni.request ç½‘ç»œé”™è¯¯
  if (err.errMsg && err.errMsg.includes("request:fail")) {
    return true;
  }

  // HTTP çŠ¶æ€ç 
  if (err.statusCode) {
    if (err.statusCode >= 500) return true; // æœåŠ¡ç«¯é”™è¯¯
    if (err.statusCode === 429) return true; // æ¥å£é™æµ
    return false; // 4xx å¤§éƒ¨åˆ†æ˜¯å‚æ•°é”™è¯¯æˆ–æƒé™é—®é¢˜ï¼Œä¸ç¼“å­˜
  }

  return false; // é»˜è®¤ä¸å¯æ¢å¤
}

// ä¸ŠæŠ¥åŸ‹ç‚¹çš„æ ¸å¿ƒå‡½æ•°ï¼ŒapiFnå°±æ˜¯åŸ‹ç‚¹ä¸ŠæŠ¥æ¥å£
// åŸ‹ç‚¹ä¸ŠæŠ¥å‡½æ•°å¯èƒ½è°ƒç”¨å¤±è´¥ï¼Œè¿™é‡Œè¿›è¡Œå¤±è´¥é‡è¯•ï¼Œå†æ¬¡å¤±è´¥å°±æŠŠå½“å‰çš„ä¸ŠæŠ¥å‡½æ•°ä¿å­˜åˆ°æœ¬åœ°ï¼Œç­‰åˆé€‚çš„æ—¶å€™ï¼Œå†æ¬¡ä¸ŠæŠ¥
async function sendReport(apiFn, params) {
  try {
    await apiFn(params); // ç¬¬ä¸€æ¬¡å°è¯•
  } catch (err) {
    // åˆ¤æ–­æ˜¯å¦ä¸º å¯æ¢å¤å¤±è´¥
    if (isRetryableError(err)) {
      console.warn("åŸ‹ç‚¹ä¸ŠæŠ¥å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•...", err);
      try {
        await apiFn(params); // é‡è¯•ä¸€æ¬¡
      } catch (err2) {
        console.error("åŸ‹ç‚¹é‡è¯•å¤±è´¥ï¼Œç¼“å­˜åˆ°æœ¬åœ°", err2);
        // ç¼“å­˜çš„ç»“æ„æ˜¯ä¸€ä¸ªå¯¹è±¡ {
        // apiFnName : fnName,
        // params : {....}
        // }
        // è¿™é‡Œä»…ä»…ç¼“å­˜äº†å‡½æ•°åç§°ï¼Œæ²¡æœ‰å®é™…çš„å‡½æ•°ä½“ï¼Œä¹Ÿæ²¡åŠæ³•é€šè¿‡setStorageSyncç¼“å­˜å‡½æ•°æœ¬èº«
        cacheReport({ apiFnName: apiFn.name, params });
      }
    } else {
      console.error(`[åŸ‹ç‚¹] ä¸å¯æ¢å¤å¤±è´¥ï¼Œä¸¢å¼ƒ: ${apiFn.name}`, err);
    }
  }
}

// ç¼“å­˜å¤±è´¥çš„åŸ‹ç‚¹ï¼ˆå­˜åˆ°æœ¬åœ°ï¼‰
function cacheReport(data) {
  // reportsæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¿å­˜äº†æ‰€æœ‰ä¸ŠæŠ¥å¤±è´¥çš„åŸ‹ç‚¹å‡½æ•°
  const reports = uni.getStorageSync(STORAGE_KEY) || [];
  reports.push({ ...data, time: Date.now() });
  uni.setStorageSync(STORAGE_KEY, reports);
}

// é‡æ–°å‘é€ç¼“å­˜çš„åŸ‹ç‚¹
async function flushReports(apiMap) {
  const reports = uni.getStorageSync(STORAGE_KEY) || [];
  console.log("åŸ‹ç‚¹ reports", reports);
  if (!reports.length) return;

  const remain = []; // æœ¬æ¬¡é‡å‘ä¸­ å†æ¬¡å¤±è´¥çš„åŸ‹ç‚¹å‡½æ•°
  for (const item of reports) {
    // itemçš„ç»“æ„ï¼š{ apiFnName: apiFn.name, params }
    const apiFn = apiMap[item.apiFnName];
    // åœ¨æ˜ å°„è¡¨ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„å‡½æ•°ï¼Œ
    if (!apiFn) {
      console.warn(`[åŸ‹ç‚¹] æ‰¾ä¸åˆ°æ¥å£: ${item.apiFnName}`);
      remain.push(item);
      continue;
    }

    try {
      await apiFn(item.params);
      console.log(`[åŸ‹ç‚¹] è¡¥å‘æˆåŠŸ: ${item.apiFnName}`);
    } catch (err) {
      console.warn(`[åŸ‹ç‚¹] è¡¥å‘å¤±è´¥ï¼Œä¿ç•™ç¼“å­˜: ${item.apiFnName}`, err);
      remain.push(item);
    }
  }

  // é‡æ–°ä¿å­˜å½“å‰å¤±è´¥çš„åŸ‹ç‚¹å‡½æ•°
  uni.setStorageSync(STORAGE_KEY, remain);
}

/**
 * è‡ªåŠ¨å®šæ—¶è¡¥å‘
 * @param {Object} apiMap { apiName: fn }
 * @param {number} interval è¡¥å‘é—´éš”ï¼Œæ¯«ç§’
 */
function startAutoFlush(apiMap, interval = 30000) {
  setInterval(() => {
    flushReports(apiMap);
  }, interval);
}

export default {
  sendReport,
  flushReports,
  startAutoFlush,
};
```



ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```js
// å›¾ç‰‡ä¿å­˜æˆåŠŸåï¼Œä¸ŠæŠ¥ä¸€æ¬¡ä¸‹è½½åŸ‹ç‚¹
Track.sendReport(downloadPicApi, {
    classid: curImageInfo.value.classid,
    wallId: curImageInfo.value._id,
});
```



`App.vue`ä¸­è®¾ç½®è¡¥å‘/è‡ªåŠ¨è¡¥å‘ï¼š

```vue
<script>
import Track from "@/utils/track";
import { downloadPicApi } from "@/api/home.js";

// åŸ‹ç‚¹å‡½æ•°æ˜ å°„è¡¨
const apiMap = {
  downloadPicApi,
};

export default {
  onLaunch: function () {
    console.log("App Launch");
    // è¡¥å‘æœ¬åœ°ç¼“å­˜çš„åŸ‹ç‚¹
    Track.flushReports(apiMap);
  },
  onShow: function () {
    console.log("App Show");
  },
  onHide: function () {
    console.log("App Hide");
  },
};
</script>
```

