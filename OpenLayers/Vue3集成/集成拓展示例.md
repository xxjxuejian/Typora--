### 需求

根据接口数据，在地图上显示站点，可能是各种类型的，显示为一个圆点标记，类型不同，颜色不同，而且要有一个扩散动画。

点击标记点时，可以弹出一个对话框，显示一些内容。



业务组件`src/views/cockpit/inde.vue`

已经通过`useOlMap` Hook完成了地图初始化

```vue
<script setup lang="ts">
import BaseMap from "@/components/BaseMap/index.vue";
import type { MapConfig } from "@/composables/map/useOlMap"; // 导入类型
import type Map from "ol/Map";

// 3. 保存地图实例引用 (使用 shallowRef 也可以，但这里为了方便直接用 Map 类型)
let mapInstance: Map | null = null;
const mapOptions: MapConfig = {
  center: [120.19, 30.26], // 杭州示例
  zoom: 11,
};

const onMapReady = (map: Map) => {
  console.log("OpenLayers Map Initialized:", map);
  mapInstance = map;
  console.log("map实例", mapInstance);
};
</script>

<template>
  <div class="wh-full relative">
    <BaseMap :options="mapOptions" @map-loaded="onMapReady" />
  </div>
</template>

<style scoped lang="scss"></style>
```



进一步添加标记物、动画与交互

确定接口数据返回的结构，或者说生成标记物需要的数据类型，定义接口

`src/composables/map/types.ts`

```ts
import type { Coordinate } from "ol/coordinate";

// 1. 定义点位类型枚举 (用于代码提示)
export type PointType = "normal" | "warning" | "offline";

// 2. 修改点位数据接口
export interface MarkerData {
  id: string | number;
  name: string;
  position: Coordinate;
  type: PointType; // 必填：决定了图标长什么样
  description?: string;
}

// 定义初始化配置的接口
export interface MapConfig {
  center?: Coordinate; // 经纬度 [经度, 纬度]
  zoom?: number;
  projection?: string;
}

// 定义颜色配置 (导出供 hook 使用)
export const COLOR_CONFIG: Record<PointType, string> = {
  normal: "#409EFF", // 蓝色
  warning: "#F56C6C", // 红色
  offline: "#909399", // 灰色
};
```



创建新的Hook：`src/composables/map/useMarker.ts`

```ts
import type { MarkerData } from "./types";
import { COLOR_CONFIG } from "./types";
import type { ShallowRef } from "vue";

import Map from "ol/Map";
import VectorLayer from "ol/layer/Vector";
import VectorSource from "ol/source/Vector";
import { Feature } from "ol";
import { Point } from "ol/geom";
import { Style, Text, Fill, Stroke, Circle } from "ol/style";

// 工具函数：生成点样式
function createPointStyle(feature: Feature) {
  const data = feature.get("data") as MarkerData;
  return new Style({
    image: new Circle({
      radius: 10,
      fill: new Fill({
        color: COLOR_CONFIG[data.type],
      }),
      stroke: new Stroke({
        color: "#fff",
        width: 2,
      }),
    }),
    text: new Text({
      text: data.name,
      font: "14px Arial",

      fill: new Fill({
        color: "#fff",
      }),
      stroke: new Stroke({
        color: "#000",
        width: 2,
      }),
      backgroundFill: new Fill({
        color: "rgba(0,0,0,0.5)",
      }),
      offsetY: -20,
    }),
  });
}
export function useMarker(mapInstance: ShallowRef<Map | null>) {
  // 在地图上添加点
  function addMarkers(dataList: MarkerData[]) {
    if (!mapInstance.value) return;

    const features = dataList.map((item) => {
      const feature = new Feature({
        geometry: new Point(item.position),
      });

      // 将业务数据绑定到 Feature 上，方便后续获取
      feature.set("data", item);
      feature.setStyle(createPointStyle(feature));
      return feature;
    });

    const vectorSource = new VectorSource({ features });
    const vectorLayer = new VectorLayer({
      source: vectorSource,
      zIndex: 10,
    });

    mapInstance.value?.addLayer(vectorLayer);
  }

  return {
    addMarkers,
  };
}

```

业务组件`src/views/cockpit/index.vue`

```vue
<script setup lang="ts">
import type { MapConfig, MarkerData } from "@/composables/map/types"; // 导入类型
import type Map from "ol/Map";

import BaseMap from "@/components/BaseMap/index.vue";

import { useMarker } from "@/composables/map/useMarker";

// 保存地图实例引用 使用 shallowRef
const mapInstance = shallowRef<Map | null>(null);
const mapOptions: MapConfig = {
  center: [120.19, 30.26], // 杭州示例
  zoom: 11,
};

const { addMarkers } = useMarker(mapInstance);
// 模拟不同类型的点位
const mockData: MarkerData[] = [
  {
    id: 1,
    name: "正常设备A",
    position: [120.15, 30.28],
    type: "normal", // 使用蓝色图标
    description: "运行良好",
  },
  {
    id: 2,
    name: "报警设备B",
    position: [120.16, 30.29],
    type: "warning", // 使用红色图标
    description: "水位超标！",
  },
  {
    id: 3,
    name: "离线设备C",
    position: [120.14, 30.27],
    type: "offline", // 使用灰色图标
    description: "无法连接",
  },
];

const onMapReady = (map: Map) => {
  console.log("OpenLayers Map Initialized:", map);
  mapInstance.value = map;
  console.log("map实例", mapInstance);
	
  // 添加点标记
  addMarkers(mockData);
	
  // 视角移动
  mapInstance.value.getView().animate({
    center: [120.14, 30.27],
    zoom: 14,
    duration: 1000,
  });
};
</script>

<template>
  <div class="wh-full relative">
    <BaseMap :options="mapOptions" @map-loaded="onMapReady" />
  </div>
</template>

<style scoped lang="scss"></style>
```





点击标记物，弹出弹窗，整个弹窗作为`overlay`显示

业务组件中需要确定好弹窗样式

业务组件`src/views/cockpit/index.vue`

```vue
<template>
  <div class="wh-full relative">
    <BaseMap :options="mapOptions" @map-loaded="onMapReady" />
	
    <!-- 弹窗 -->
    <div v-show="selectedMarker" ref="popupRef" class="absolute min-w-[200px]">
      <el-card>
        <template #header>
          <div class="font-bold flex justify-between">
            <span>{{ selectedMarker?.name }}</span>
            <div class="i-svg:xmark cursor-pointer" @click="closePopup"></div>
          </div>
        </template>

        <div class="text-sm text-gray-600 p-4">
          <div>ID: {{ selectedMarker?.id }}</div>
          <div>描述: {{ selectedMarker?.description || "暂无描述" }}</div>
          <el-button type="primary" size="small" class="mt-2">查看详情</el-button>
        </div>
      </el-card>
    </div>
  </div>
</template>
```



创建`overlay`，保存点击时的标记物数据

修改useMarker

```ts
export function useMarker(mapInstance: ShallowRef<Map | null>, popupRef: Ref<HTMLElement | null>) 
```



```ts
import type { MarkerData } from "./types";
import { COLOR_CONFIG } from "./types";
import type { ShallowRef } from "vue";

import Map from "ol/Map";
import VectorLayer from "ol/layer/Vector";
import VectorSource from "ol/source/Vector";
import Overlay from "ol/Overlay";
import { Feature } from "ol";
import { Point } from "ol/geom";
import { Style, Text, Fill, Stroke, Circle } from "ol/style";


export function useMarker(mapInstance: ShallowRef<Map | null>, popupRef: Ref<HTMLElement | null>)  {
  // 选中的点位数据（用于弹窗展示），必须是响应式的，这样在父组件中数据变化时，才能更新弹出内容
  const selectedMarker = ref<MarkerData | null>(null);
  // 保存 Overlay 实例
  let overlayInstance: Overlay | null = null;
    
    // 初始化弹窗 Overlay
  const initOverlay = () => {
    if (!mapInstance.value || !popupRef.value) return;

    overlayInstance = new Overlay({
      element: popupRef.value,
      // autoPan: true, // 弹窗超出屏幕时自动平移地图
      positioning: "bottom-center", // 弹窗在坐标点上方
      offset: [0, -50], // 向上偏移，避开图标
    });
    mapInstance.value.addOverlay(overlayInstance);
  };
    

  //   绑定交互事件 (Hover & Click)
  function bindInteractions() {
    const map = mapInstance.value;
    if (!map) return;

    // 鼠标点击 feature 的交互
    map.on("click", (e) => {
      const feature = map.forEachFeatureAtPixel(e.pixel, (feature) => feature);
      //   确定点击的是 我们需要的点位
        if (feature && feature.get("data")) {
            // 点击到了点位
            const data = feature.get("data") as MarkerData;
            selectedMarker.value = data; // 更新 Vue 数据

            // 设置弹窗位置 (使用 Feature 的坐标)
            const geometry = feature.getGeometry() as Point;
            overlayInstance?.setPosition(geometry.getCoordinates());
        } else {
            // 点击空白处，关闭弹窗
            closePopup();
        }
    });
  }
    
      // 关闭弹窗方法
  const closePopup = () => {
    overlayInstance?.setPosition(undefined); // undefined 会隐藏 Overlay
    selectedMarker.value = null;
  };

  return {
    addMarkers,
    bindInteractions,
    selectedMarker,
    initOverlay,
    closePopup,
  };
}
```



```ts
const { selectedMarker, initOverlay, closePopup, addMarkers, bindInteractions } = useMarker(
  mapInstance,
  popupRef
);

const onMapReady = (map: Map) => {
  mapInstance.value = map;

  addMarkers(mockData);
  initOverlay();
  bindInteractions();
};
```

